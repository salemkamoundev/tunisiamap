------------------------------
ðŸ“„ Fichier : src/index.html
------------------------------
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>TunisiaMapProject</title>
  <base href="/">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="favicon.ico">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
</head>
<body>
  <app-root></app-root>
</body>
</html>

------------------------------
ðŸ“„ Fichier : src/app/app.component.html
------------------------------
<div class="map-container">
  
  <div class="map-controls">
    <div class="main-select">
      <label><strong>CatÃ©gorie :</strong></label>
      <select (change)="onCategoryChange($any($event))">
        <option *ngFor="let cat of categories" [value]="cat">
          {{ cat }}
        </option>
      </select>
    </div>

    <div *ngIf="isBudgetActive || isRecetteActive" class="filter-container">
      <hr>
      <div class="filter-header" [class.recette-header]="isRecetteActive">
        <strong>Filtres {{ isRecetteActive ? 'Recettes' : 'Budget' }}</strong>
        <button class="toggle-btn" (click)="filtersVisible = !filtersVisible">
          {{ filtersVisible ? 'Masquer' : 'Afficher' }}
        </button>
      </div>

      <div *ngIf="filtersVisible" class="filter-body">
        <div class="filter-group">
          <label>Gouvernorat :</label>
          <select [(ngModel)]="selectedGov" (change)="applyFilters()">
            <option value="">(Tous)</option>
            <option *ngFor="let g of listGouvernorats" [value]="g">{{ g }}</option>
          </select>
        </div>

        <div class="filter-group">
          <label>MunicipalitÃ© :</label>
          <select [(ngModel)]="selectedMun" (change)="applyFilters()">
            <option value="">(Toutes)</option>
            <option *ngFor="let m of listMunicipalites" [value]="m">{{ m }}</option>
          </select>
        </div>

        <button class="reset-btn" (click)="resetFilters()">RÃ©initialiser</button>
      </div>
    </div>
  </div>

  <div id="map"></div>
</div>

------------------------------
ðŸ“„ Fichier : src/app/app.ts
------------------------------
import { Component, AfterViewInit } from '@angular/core';
import { CommonModule } from '@angular/common'; 
import { HttpClientModule } from '@angular/common/http';
import { FormsModule } from '@angular/forms'; 
import { MapDataService } from './services/map-data.service';

declare const L: any;

@Component({
  selector: 'app-root',
  standalone: true,
  imports: [CommonModule, HttpClientModule, FormsModule],
  templateUrl: './app.html',
  styleUrls: ['./app.css'],
  providers: [MapDataService]
})
export class App implements AfterViewInit {
  map!: any;
  currentLayer: any = null;
  activeLayers: any[] = []; // Pour le multi-cluster

  categories: string[] = [ 
    'Stade', 'LycÃ©e', 'Maison des Jeunes', 'Poste', 'UniversitÃ©', 'Ã‰cole', 
    'Budget 2021', 'Recette MunicipalitÃ©s' 
  ];

  // Etat
  currentCategory: string = 'Toutes';
  isBudgetActive: boolean = false;
  isRecetteActive: boolean = false;
  filtersVisible: boolean = true;
  
  // DonnÃ©es Budget
  allBudgetData: any[] = [];
  filteredBudgetData: any[] = [];
  
  // DonnÃ©es Recette
  allRecetteData: any[] = [];
  filteredRecetteData: any[] = [];

  // Listes Filtres (PartagÃ©es ou distinctes selon besoin)
  listGouvernorats: string[] = [];
  listMunicipalites: string[] = [];
  
  selectedGov: string = '';
  selectedMun: string = '';

  constructor(private mapService: MapDataService) {}

  ngAfterViewInit() {
    this.initMap();
  }

  initMap() {
    this.map = L.map('map').setView([33.8869, 9.5375], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(this.map);
    this.loadStandardData('Toutes');
  }

  onCategoryChange(event: any) {
    const selectedCat = event.target.value;
    this.currentCategory = selectedCat;
    
    // Reset Ã©tats
    this.isBudgetActive = (selectedCat === 'Budget 2021');
    this.isRecetteActive = (selectedCat === 'Recette MunicipalitÃ©s');
    
    // Reset Filtres UI
    this.selectedGov = '';
    this.selectedMun = '';
    this.listGouvernorats = [];
    this.listMunicipalites = [];

    this.clearMap();

    if (this.isBudgetActive) {
      this.loadBudgetData();
    } else if (this.isRecetteActive) {
      this.loadRecetteData();
    } else {
      this.loadStandardData(selectedCat);
    }
  }

  clearMap() {
    if (this.currentLayer) this.map.removeLayer(this.currentLayer);
    this.activeLayers.forEach(l => this.map.removeLayer(l));
    this.activeLayers = [];
    this.currentLayer = null;
  }

  // --- LOGIQUE COMMUNE FILTRES ---
  extractFilters(data: any[], govKey: string, munKey: string) {
    const govs = data.map(item => item[govKey]).filter(Boolean);
    this.listGouvernorats = [...new Set(govs)].sort();
    const muns = data.map(item => item[munKey]).filter(Boolean);
    this.listMunicipalites = [...new Set(muns)].sort();
  }

  applyFilters() {
    if (this.isBudgetActive) {
      this.filteredBudgetData = this.filterData(this.allBudgetData, 'Nom_Gouvernorat_Ar', 'Nom_Municipalite_Ar');
      this.renderHierarchicalCluster(this.filteredBudgetData, 'budget');
    } else if (this.isRecetteActive) {
      // Mapping des clÃ©s si fichier brut (FIELD3 = Gov, FIELD2 = Mun)
      // Ou clÃ©s directes si fichier propre. Adaptez selon votre JSON rÃ©el.
      // Ici je suppose que le JSON a des clÃ©s propres comme dans Budget.
      // Si c'est FIELD3/FIELD2, changez ci-dessous.
      this.filteredRecetteData = this.filterData(this.allRecetteData, 'Nom_Gouvernorat_Ar', 'Nom_Municipalite_Ar');
      this.renderHierarchicalCluster(this.filteredRecetteData, 'recette');
    }
  }

  filterData(data: any[], govKey: string, munKey: string) {
    return data.filter(item => {
      const matchGov = this.selectedGov ? item[govKey] === this.selectedGov : true;
      const matchMun = this.selectedMun ? item[munKey] === this.selectedMun : true;
      return matchGov && matchMun;
    });
  }

  resetFilters() {
    this.selectedGov = '';
    this.selectedMun = '';
    this.applyFilters();
  }

  // --- CHARGEMENT BUDGET ---
  loadBudgetData() {
    this.mapService.getBudget2021().subscribe({
      next: (data) => {
        this.allBudgetData = data;
        this.extractFilters(data, 'Nom_Gouvernorat_Ar', 'Nom_Municipalite_Ar');
        this.filteredBudgetData = data;
        this.renderHierarchicalCluster(data, 'budget');
      },
      error: (e) => console.error(e)
    });
  }

  // --- CHARGEMENT RECETTE ---
  loadRecetteData() {
    this.mapService.getRecetteMunicipalites().subscribe({
      next: (data) => {
        // Mapping optionnel si donnÃ©es brutes FIELD...
        // data = data.map(d => ({ ...d, Nom_Gouvernorat_Ar: d.FIELD3, ... }));
        
        this.allRecetteData = data;
        // Adapter les clÃ©s si nÃ©cessaire (ex: FIELD3 pour Gov)
        this.extractFilters(data, 'Nom_Gouvernorat_Ar', 'Nom_Municipalite_Ar'); 
        this.filteredRecetteData = data;
        this.renderHierarchicalCluster(data, 'recette');
      },
      error: (e) => console.error(e)
    });
  }

  // --- RENDU HIERARCHIQUE GENERIQUE (Budget & Recette) ---
  renderHierarchicalCluster(data: any[], type: 'budget' | 'recette') {
    this.clearMap();

    const groupedByGov: { [key: string]: any[] } = {};
    const govKey = 'Nom_Gouvernorat_Ar'; // Ou FIELD3

    data.forEach(item => {
      const g = item[govKey] || 'Autre';
      if (!groupedByGov[g]) groupedByGov[g] = [];
      groupedByGov[g].push(item);
    });

    Object.keys(groupedByGov).forEach(govName => {
      const groupData = groupedByGov[govName];
      const cluster = L.markerClusterGroup({
        maxClusterRadius: 80,
        iconCreateFunction: (c: any) => this.createClusterIcon(c, govName, type)
      });

      groupData.forEach(item => {
        const marker = this.createMarker(item, type);
        if (marker) cluster.addLayer(marker);
      });

      this.activeLayers.push(cluster);
      this.map.addLayer(cluster);
    });

    if (this.activeLayers.length > 0) {
       const bounds = this.activeLayers[0].getBounds();
       if(bounds.isValid()) this.map.fitBounds(bounds);
    }
  }

  createClusterIcon(cluster: any, defaultLabel: string, type: 'budget' | 'recette') {
    const markers = cluster.getAllChildMarkers();
    let total = 0;
    const muns = new Set();

    markers.forEach((m: any) => {
      if (m.options.amount) total += m.options.amount;
      if (m.options.munName) muns.add(m.options.munName);
    });

    let label = defaultLabel;
    let cssType = type === 'budget' ? 'gouvernorat' : 'recette-gov'; // Classe CSS diffÃ©rente
    let cssSub = type === 'budget' ? 'municipalite' : 'recette-mun';

    if (muns.size === 1) {
      label = [...muns][0] as string;
      cssType = cssSub;
    }

    const fmt = new Intl.NumberFormat('fr-TN', { 
      style: 'currency', currency: 'TND', maximumFractionDigits: 0 
    }).format(total);

    return L.divIcon({
      html: `<div class="budget-cluster-icon ${cssType}">
               <span class="amount">${fmt}</span>
               <span class="location">${label}</span>
               <small>(${markers.length})</small>
             </div>`,
      className: 'budget-cluster',
      iconSize: L.point(100, 100)
    });
  }

  createMarker(item: any, type: 'budget' | 'recette') {
    const lat = parseFloat(item.lat);
    const lng = parseFloat(item.lng);
    
    // ClÃ©s dynamiques selon le type
    // Budget : depenses_prevision / Recette : recettes_previsions (ou FIELD20)
    let rawAmount = '0';
    if (type === 'budget') rawAmount = item.depenses_prevision;
    if (type === 'recette') rawAmount = item.recettes_previsions || item.FIELD20; // Supporte les 2 formats

    if (isNaN(lat) || isNaN(lng)) return null;

    const val = parseFloat(String(rawAmount).replace(/\s/g, '').replace(',', '.'));

    const marker = L.marker([lat, lng], {
      icon: L.icon({
        iconUrl: 'assets/marker-icon.png',
        shadowUrl: 'assets/marker-shadow.png',
        iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34]
      })
    });

    (marker as any).options.amount = val;
    (marker as any).options.govName = item.Nom_Gouvernorat_Ar || item.FIELD3;
    (marker as any).options.munName = item.Nom_Municipalite_Ar || item.FIELD2;

    marker.bindPopup(this.generateFullPopup(item));
    return marker;
  }

  // --- STANDARDS ---
  loadStandardData(cat: string) {
    this.mapService.getLocations().subscribe({
      next: (locs) => {
        const filtered = cat === 'Toutes' ? locs : locs.filter(l => l.categorie === cat);
        const cluster = L.markerClusterGroup();
        filtered.forEach(l => {
           const m = L.marker([l.lat, l.lng], {
             icon: L.icon({
               iconUrl: 'assets/marker-icon.png',
               shadowUrl: 'assets/marker-shadow.png',
               iconSize: [25, 41], iconAnchor: [12, 41]
             })
           });
           m.bindPopup(`<b>${l.nom}</b><br>${l.categorie}`);
           cluster.addLayer(m);
        });
        this.activeLayers.push(cluster);
        this.map.addLayer(cluster);
        if(filtered.length > 0) {
            const b = cluster.getBounds();
            if(b.isValid()) this.map.fitBounds(b);
        }
      }
    });
  }

  generateFullPopup(data: any): string {
    let rows = '';
    for (const key in data) {
      if (data.hasOwnProperty(key) && key !== 'lat' && key !== 'lng') {
         rows += `<tr><td style="font-weight:bold">${key}</td><td>${data[key]}</td></tr>`;
      }
    }
    return `<div style="max-height:300px;overflow:auto"><table>${rows}</table></div>`;
  }
}

------------------------------
ðŸ“„ Fichier : src/app/app.css
------------------------------
.map-container { position: relative; height: 100vh; width: 100%; display: flex; flex-direction: column; }
#map { flex-grow: 1; width: 100%; height: 100%; z-index: 1; }

.map-controls { position: absolute; top: 20px; right: 20px; z-index: 1000; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); min-width: 250px; }
.main-select select { width: 100%; padding: 6px; margin-top: 5px; }

/* Filtres */
.filter-container { margin-top: 10px; animation: fadeIn 0.3s; }
.filter-header { display: flex; justify-content: space-between; margin-bottom: 10px; color: #28a745; }
.filter-header.recette-header { color: #007bff; /* Bleu pour Recette */ }

.toggle-btn { background: none; border: none; color: #666; font-size: 11px; cursor: pointer; text-decoration: underline; }
.filter-group { margin-bottom: 8px; }
.filter-group label { display: block; font-size: 12px; color: #555; }
.filter-group select { width: 100%; padding: 4px; }
.reset-btn { width: 100%; padding: 6px; margin-top: 5px; background-color: #f8f9fa; border: 1px solid #ddd; cursor: pointer; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

/* --- CLUSTERS --- */
::ng-deep .budget-cluster-icon {
  border-radius: 50%;
  color: white;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  width: 100px; 
  height: 100px; 
  box-shadow: 0 5px 15px rgba(0,0,0,0.4);
  text-align: center;
  cursor: pointer;
  padding: 5px;
  overflow: hidden;
  transition: transform 0.2s;
}
::ng-deep .budget-cluster-icon:hover { transform: scale(1.1); z-index: 9999; }
::ng-deep .budget-cluster-icon .amount { font-weight: bold; font-size: 11px; line-height: 1.2; }
::ng-deep .budget-cluster-icon small { font-size: 9px; opacity: 0.8; font-weight: normal; }
::ng-deep .budget-cluster-icon .location { font-size: 10px; font-weight: bold; color: #fff; margin: 2px 0; }

/* --- BUDGET (Vert) --- */
::ng-deep .budget-cluster-icon.gouvernorat { background-color: rgba(33, 136, 56, 0.95); border: 3px solid #c3e6cb; }
::ng-deep .budget-cluster-icon.municipalite { background-color: rgba(40, 167, 69, 0.95); border: 2px solid white; }

/* --- RECETTE (Bleu) --- */
::ng-deep .budget-cluster-icon.recette-gov { background-color: rgba(0, 86, 179, 0.95); border: 3px solid #b8daff; }
::ng-deep .budget-cluster-icon.recette-mun { background-color: rgba(0, 123, 255, 0.95); border: 2px solid white; }

------------------------------
ðŸ“„ Fichier : src/app/app.component.ts
------------------------------
import { Component, AfterViewInit } from '@angular/core';
import { CommonModule } from '@angular/common'; 
import { HttpClientModule } from '@angular/common/http';
import { FormsModule } from '@angular/forms'; 
import { forkJoin } from 'rxjs'; // Pour charger 2 fichiers en mÃªme temps
import { MapDataService } from './services/map-data.service';

declare const L: any;

@Component({
  selector: 'app-root',
  standalone: true,
  imports: [CommonModule, HttpClientModule, FormsModule],
  templateUrl: './app.component.html',
  styleUrls: ['./app.component.css'],
  providers: [MapDataService]
})
export class AppComponent implements AfterViewInit {
  map!: any;
  currentLayer: any = null;
  activeLayers: any[] = [];

  categories: string[] = [ 
    'Stade', 'LycÃ©e', 'Maison des Jeunes', 'Poste', 'UniversitÃ©', 'Ã‰cole', 
    'Budget 2021', 'Recette MunicipalitÃ©s' 
  ];

  isBudgetActive: boolean = false;
  isRecetteActive: boolean = false;
  filtersVisible: boolean = true;
  
  allBudgetData: any[] = [];
  allRecetteData: any[] = [];
  
  // Listes pour les filtres
  listGouvernorats: string[] = [];
  listMunicipalites: string[] = [];
  
  selectedGov: string = '';
  selectedMun: string = '';

  // DonnÃ©es filtrÃ©es
  currentFilteredData: any[] = [];

  constructor(private mapService: MapDataService) {}

  ngAfterViewInit() {
    setTimeout(() => {
        if (typeof L !== 'undefined') this.initMap();
    }, 200);
  }

  initMap() {
    this.map = L.map('map').setView([33.8869, 9.5375], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(this.map);
    this.loadStandardData('Toutes');
  }

  onCategoryChange(event: any) {
    const selectedCat = event.target.value;
    
    // Reset
    this.isBudgetActive = (selectedCat === 'Budget 2021');
    this.isRecetteActive = (selectedCat === 'Recette MunicipalitÃ©s');
    this.selectedGov = '';
    this.selectedMun = '';
    this.listGouvernorats = [];
    this.listMunicipalites = [];
    this.clearMap();

    if (this.isBudgetActive) {
      this.loadBudgetData();
    } else if (this.isRecetteActive) {
      this.loadRecetteData();
    } else {
      this.loadStandardData(selectedCat);
    }
  }

  clearMap() {
    if (this.currentLayer) this.map.removeLayer(this.currentLayer);
    this.activeLayers.forEach(l => this.map.removeLayer(l));
    this.activeLayers = [];
    this.currentLayer = null;
  }

  // --- 1. CHARGEMENT BUDGET (inchangÃ©) ---
  loadBudgetData() {
    this.mapService.getBudget2021().subscribe({
      next: (data) => {
        this.allBudgetData = data;
        this.prepareFilters(data, 'Nom_Gouvernorat_Ar', 'Nom_Municipalite_Ar');
        this.currentFilteredData = data;
        this.renderHierarchicalCluster(data, 'budget');
      },
      error: (e) => console.error(e)
    });
  }

  // --- 2. CHARGEMENT RECETTE (Nouveau : Jointure avec Budget pour GPS) ---
  loadRecetteData() {
    // On charge Budget (pour les coords) ET Recettes (pour les montants)
    forkJoin({
      budget: this.mapService.getBudget2021(),
      recette: this.mapService.getRecetteMunicipalites()
    }).subscribe({
      next: (res) => {
        // 1. CrÃ©ation d'un dictionnaire de coordonnÃ©es depuis le Budget
        // ClÃ© = Code MunicipalitÃ© (Code_Municipalite_INS)
        const coordsMap = new Map();
        res.budget.forEach((b: any) => {
          if (b.lat && b.lng && b.Code_Municipalite_INS) {
            coordsMap.set(b.Code_Municipalite_INS, { lat: b.lat, lng: b.lng });
          }
        });

        // 2. Nettoyage et Enrichissement des Recettes
        const mergedData: any[] = [];
        
        res.recette.forEach((r: any) => {
          // On ignore la ligne d'en-tÃªte si elle existe ("FIELD1" == "Code_Municipalite_INS")
          if (r.FIELD1 === 'Code_Municipalite_INS') return;

          // On rÃ©cupÃ¨re les coords via le code municipalitÃ© (FIELD1)
          const coords = coordsMap.get(r.FIELD1);

          if (coords) {
            mergedData.push({
              // On garde les donnÃ©es d'origine
              ...r,
              // On ajoute les coords
              lat: coords.lat,
              lng: coords.lng,
              // On mappe les champs cryptiques vers des noms lisibles pour notre code
              Nom_Municipalite_Ar: r.FIELD2,
              Nom_Gouvernorat_Ar: r.FIELD3,
              recettes_previsions: r.FIELD20,
              recettes_realisations: r.FIELD21,
              // libellÃ© article (utile pour le popup)
              lib_article: r.FIELD16 
            });
          }
        });

        this.allRecetteData = mergedData;
        
        // 3. Initialisation des filtres et affichage
        this.prepareFilters(mergedData, 'Nom_Gouvernorat_Ar', 'Nom_Municipalite_Ar');
        this.currentFilteredData = mergedData;
        this.renderHierarchicalCluster(mergedData, 'recette');
      },
      error: (e) => console.error('Erreur chargement jointure:', e)
    });
  }

  // --- FILTRES ---
  prepareFilters(data: any[], govKey: string, munKey: string) {
    const govs = data.map(item => item[govKey]).filter(Boolean);
    this.listGouvernorats = [...new Set(govs)].sort();
    const muns = data.map(item => item[munKey]).filter(Boolean);
    this.listMunicipalites = [...new Set(muns)].sort();
  }

  applyFilters() {
    const sourceData = this.isBudgetActive ? this.allBudgetData : this.allRecetteData;
    const type = this.isBudgetActive ? 'budget' : 'recette';
    
    // GrÃ¢ce au mapping, on utilise les mÃªmes clÃ©s pour les deux !
    const govKey = 'Nom_Gouvernorat_Ar';
    const munKey = 'Nom_Municipalite_Ar';

    this.currentFilteredData = sourceData.filter(item => {
      const matchGov = this.selectedGov ? item[govKey] === this.selectedGov : true;
      const matchMun = this.selectedMun ? item[munKey] === this.selectedMun : true;
      return matchGov && matchMun;
    });

    this.renderHierarchicalCluster(this.currentFilteredData, type);
  }

  resetFilters() {
    this.selectedGov = '';
    this.selectedMun = '';
    this.applyFilters();
  }

  // --- RENDU CLUSTER ---
  renderHierarchicalCluster(data: any[], type: 'budget' | 'recette') {
    this.clearMap();

    const groupedByGov: { [key: string]: any[] } = {};
    const govKey = 'Nom_Gouvernorat_Ar'; 

    data.forEach(item => {
      const g = item[govKey] || 'Autre';
      if (!groupedByGov[g]) groupedByGov[g] = [];
      groupedByGov[g].push(item);
    });

    Object.keys(groupedByGov).forEach(govName => {
      const groupData = groupedByGov[govName];
      const cluster = L.markerClusterGroup({
        maxClusterRadius: 80,
        iconCreateFunction: (c: any) => this.createClusterIcon(c, govName, type)
      });

      groupData.forEach(item => {
        const marker = this.createMarker(item, type);
        if (marker) cluster.addLayer(marker);
      });

      this.activeLayers.push(cluster);
      this.map.addLayer(cluster);
    });

    if (this.activeLayers.length > 0) {
       const bounds = this.activeLayers[0].getBounds();
       if(bounds.isValid()) this.map.fitBounds(bounds);
    }
  }

  createClusterIcon(cluster: any, defaultLabel: string, type: 'budget' | 'recette') {
    const markers = cluster.getAllChildMarkers();
    let total = 0;
    const muns = new Set();

    markers.forEach((m: any) => {
      if (m.options.amount) total += m.options.amount;
      if (m.options.munName) muns.add(m.options.munName);
    });

    let label = defaultLabel;
    let cssType = type === 'budget' ? 'gouvernorat' : 'recette-gov'; 
    let cssSub = type === 'budget' ? 'municipalite' : 'recette-mun';

    if (muns.size === 1) {
      label = [...muns][0] as string;
      cssType = cssSub;
    }

    const fmt = new Intl.NumberFormat('fr-TN', { 
      style: 'currency', currency: 'TND', maximumFractionDigits: 0 
    }).format(total);

    return L.divIcon({
      html: `<div class="budget-cluster-icon ${cssType}">
               <span class="amount">${fmt}</span>
               <span class="location">${label}</span>
               <small>(${markers.length})</small>
             </div>`,
      className: 'budget-cluster',
      iconSize: L.point(100, 100)
    });
  }

  createMarker(item: any, type: 'budget' | 'recette') {
    const lat = parseFloat(item.lat);
    const lng = parseFloat(item.lng);
    
    let rawAmount = '0';
    if (type === 'budget') rawAmount = item.depenses_prevision;
    if (type === 'recette') rawAmount = item.recettes_previsions || item.FIELD20; // Support FIELD20

    if (isNaN(lat) || isNaN(lng)) return null;

    const val = parseFloat(String(rawAmount).replace(/\s/g, '').replace(',', '.'));

    const marker = L.marker([lat, lng], {
      icon: L.icon({
        iconUrl: 'assets/marker-icon.png',
        shadowUrl: 'assets/marker-shadow.png',
        iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34]
      })
    });

    (marker as any).options.amount = val;
    (marker as any).options.govName = item.Nom_Gouvernorat_Ar;
    (marker as any).options.munName = item.Nom_Municipalite_Ar;

    marker.bindPopup(this.generateFullPopup(item));
    return marker;
  }

  // --- STANDARDS ---
  loadStandardData(cat: string) {
    this.mapService.getLocations().subscribe({
      next: (locs) => {
        const filtered = cat === 'Toutes' ? locs : locs.filter(l => l.categorie === cat);
        const cluster = L.markerClusterGroup();
        if(filtered) {
            filtered.forEach(l => {
               const lat = parseFloat(l.lat);
               const lng = parseFloat(l.lng);
               if(!isNaN(lat) && !isNaN(lng)) {
                   const m = L.marker([lat, lng], {
                     icon: L.icon({
                       iconUrl: 'assets/marker-icon.png',
                       shadowUrl: 'assets/marker-shadow.png',
                       iconSize: [25, 41], iconAnchor: [12, 41]
                     })
                   });
                   m.bindPopup(`<b>${l.nom}</b><br>${l.categorie}`);
                   cluster.addLayer(m);
               }
            });
        }
        this.activeLayers.push(cluster);
        this.map.addLayer(cluster);
        if(filtered && filtered.length > 0) {
            const b = cluster.getBounds();
            if(b.isValid()) this.map.fitBounds(b);
        }
      }
    });
  }

  generateFullPopup(data: any): string {
    let rows = '';
    // On affiche tout sauf les champs techniques qu'on a ajoutÃ©s ou qui sont redondants
    const ignore = ['lat', 'lng', 'Code_Municipalite_INS', 'Nom_Municipalite_Ar', 'Nom_Gouvernorat_Ar', 'recettes_previsions', 'recettes_realisations', 'FIELD1', 'FIELD3', 'FIELD4'];
    
    for (const key in data) {
      if (!ignore.includes(key)) {
         rows += `<tr><td style="font-weight:bold; padding:2px 5px">${key}</td><td style="padding:2px 5px">${data[key]}</td></tr>`;
      }
    }
    // On ajoute proprement les champs importants en haut
    const header = `
        <tr><td style="font-weight:bold">MunicipalitÃ©</td><td>${data.Nom_Municipalite_Ar}</td></tr>
        <tr><td style="font-weight:bold">Gouvernorat</td><td>${data.Nom_Gouvernorat_Ar}</td></tr>
        <tr><td style="font-weight:bold">PrÃ©visions</td><td>${data.recettes_previsions}</td></tr>
    `;

    return `<div style="max-height:300px;overflow:auto;font-size:12px"><table>${header}${rows}</table></div>`;
  }
}

------------------------------
ðŸ“„ Fichier : src/app/app.config.ts
------------------------------
import { ApplicationConfig, provideBrowserGlobalErrorListeners, provideZoneChangeDetection } from '@angular/core';
import { provideHttpClient } from '@angular/common/http';

export const appConfig: ApplicationConfig = {
  providers: [
    provideBrowserGlobalErrorListeners(),
    provideZoneChangeDetection({ eventCoalescing: true }),
    provideHttpClient()
  ]
};

------------------------------
ðŸ“„ Fichier : src/app/app.component.css
------------------------------
.map-container { position: relative; height: 100vh; width: 100%; display: flex; flex-direction: column; }
#map { flex-grow: 1; width: 100%; height: 100%; z-index: 1; }

.map-controls { position: absolute; top: 20px; right: 20px; z-index: 1000; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); min-width: 250px; }
.main-select select { width: 100%; padding: 6px; margin-top: 5px; }

/* Filtres */
.filter-container { margin-top: 10px; animation: fadeIn 0.3s; }
.filter-header { display: flex; justify-content: space-between; margin-bottom: 10px; color: #28a745; }
.filter-header.recette-header { color: #007bff; } /* Bleu si Recette */

.toggle-btn { background: none; border: none; color: #666; font-size: 11px; cursor: pointer; text-decoration: underline; }
.filter-group { margin-bottom: 8px; }
.filter-group label { display: block; font-size: 12px; color: #555; }
.filter-group select { width: 100%; padding: 4px; }
.reset-btn { width: 100%; padding: 6px; margin-top: 5px; background-color: #f8f9fa; border: 1px solid #ddd; cursor: pointer; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

/* --- CLUSTERS --- */
::ng-deep .budget-cluster-icon {
  border-radius: 50%;
  color: white;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  width: 100px; 
  height: 100px; 
  box-shadow: 0 5px 15px rgba(0,0,0,0.4);
  text-align: center;
  cursor: pointer;
  padding: 5px;
  overflow: hidden;
  transition: transform 0.2s;
}
::ng-deep .budget-cluster-icon:hover { transform: scale(1.1); z-index: 9999; }
::ng-deep .budget-cluster-icon .amount { font-weight: bold; font-size: 11px; line-height: 1.2; }
::ng-deep .budget-cluster-icon small { font-size: 9px; opacity: 0.8; font-weight: normal; }
::ng-deep .budget-cluster-icon .location { font-size: 10px; font-weight: bold; color: #fff; margin: 2px 0; }

/* --- BUDGET (Vert) --- */
::ng-deep .budget-cluster-icon.gouvernorat { background-color: rgba(33, 136, 56, 0.95); border: 3px solid #c3e6cb; }
::ng-deep .budget-cluster-icon.municipalite { background-color: rgba(40, 167, 69, 0.95); border: 2px solid white; }

/* --- RECETTE (Bleu) --- */
::ng-deep .budget-cluster-icon.recette-gov { background-color: rgba(0, 86, 179, 0.95); border: 3px solid #b8daff; }
::ng-deep .budget-cluster-icon.recette-mun { background-color: rgba(0, 123, 255, 0.95); border: 2px solid white; }

------------------------------
ðŸ“„ Fichier : src/app/app.html
------------------------------
<div class="map-container">
  
  <div class="map-controls">
    <div class="main-select">
      <label><strong>CatÃ©gorie :</strong></label>
      <select (change)="onCategoryChange($any($event))">
        <option *ngFor="let cat of categories" [value]="cat">
          {{ cat }}
        </option>
      </select>
    </div>

    <div *ngIf="isBudgetActive || isRecetteActive" class="filter-container">
      <hr>
      <div class="filter-header" [class.recette-header]="isRecetteActive">
        <strong>Filtres {{ isRecetteActive ? 'Recettes' : 'Budget' }}</strong>
        <button class="toggle-btn" (click)="filtersVisible = !filtersVisible">
          {{ filtersVisible ? 'Masquer' : 'Afficher' }}
        </button>
      </div>

      <div *ngIf="filtersVisible" class="filter-body">
        
        <div class="filter-group">
          <label>Gouvernorat :</label>
          <select [(ngModel)]="selectedGov" (change)="applyFilters()">
            <option value="">(Tous)</option>
            <option *ngFor="let g of listGouvernorats" [value]="g">{{ g }}</option>
          </select>
        </div>

        <div class="filter-group">
          <label>MunicipalitÃ© :</label>
          <select [(ngModel)]="selectedMun" (change)="applyFilters()">
            <option value="">(Toutes)</option>
            <option *ngFor="let m of listMunicipalites" [value]="m">{{ m }}</option>
          </select>
        </div>

        <button class="reset-btn" (click)="resetFilters()">RÃ©initialiser</button>
      </div>
    </div>
  </div>

  <div id="map"></div>
</div>

------------------------------
ðŸ“„ Fichier : src/app/services/map-data.service.ts
------------------------------
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Observable } from 'rxjs';

@Injectable({
  providedIn: 'root'
})
export class MapDataService {
  constructor(private http: HttpClient) { }

  getLocations(): Observable<any[]> {
    return this.http.get<any[]>('assets/all_locations.json');
  }

  getBudget2021(): Observable<any[]> {
    return this.http.get<any[]>('assets/budget2021.json');
  }

  getRecetteMunicipalites(): Observable<any[]> {
    return this.http.get<any[]>('assets/recetteMunicipalites.json');
  }

  getDelegations(): Observable<any[]> {
    return this.http.get<any[]>('assets/delegations.json');
  }
}

------------------------------
ðŸ“„ Fichier : src/app/services/map-data.ts
------------------------------
import { Injectable } from '@angular/core';

@Injectable({
  providedIn: 'root',
})
export class MapData {
  
}

------------------------------
ðŸ“„ Fichier : src/main.ts
------------------------------
import { bootstrapApplication } from '@angular/platform-browser';
import { appConfig } from './app/app.config';
import { AppComponent } from './app/app.component';

// NOTE : Aucune importation de Leaflet ici.
// Leaflet est chargÃ© globalement par le CDN dans index.html.

bootstrapApplication(AppComponent, appConfig)
  .catch((err) => console.error(err));

------------------------------
ðŸ“„ Fichier : src/styles.css
------------------------------
/* Styles globaux */
html, body { 
    height: 100%; 
    margin: 0; 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

/* Note: Les CSS de Leaflet sont chargÃ©s via CDN dans index.html */

