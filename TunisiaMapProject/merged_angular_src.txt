------------------------------
ðŸ“„ Fichier : src/app/app.component.html
------------------------------
<div class="map-container">
  
  <div class="map-controls">
    <label for="catSelect"><strong>Choisissez une catÃ©gorie :</strong></label>
    <select id="catSelect" (change)="onCategoryChange($any($event))">
      <option *ngFor="let cat of categories" [value]="cat">
        {{ cat }}
      </option>
    </select>
  </div>

  <div
    id="map"
    leaflet
    [leafletOptions]="options"
    (leafletMapReady)="onMapReady($any($event))">
  </div>

</div>

------------------------------
ðŸ“„ Fichier : src/app/app.ts
------------------------------
import { Component } from '@angular/core';
import { CommonModule } from '@angular/common'; 
import { HttpClientModule } from '@angular/common/http';
import { LeafletModule } from '@bluehalo/ngx-leaflet'; 
// import { LeafletModule } from 'ngx-leaflet'; // DÃ©commentez si @bluehalo ne marche pas

import * as L from 'leaflet';
import 'leaflet.markercluster'; 
import { MapDataService } from './services/map-data.service';

@Component({
  selector: 'app-root',
  standalone: true,
  imports: [CommonModule, LeafletModule, HttpClientModule],
  templateUrl: './app.html',
  styleUrls: ['./app.css'],
  providers: [MapDataService]
})
export class App {
  map!: L.Map;
  currentLayer: any = null;

  // DÃ©finition explicite des catÃ©gories pour le menu
  categories: string[] = [
    'LycÃ©e',
    'Maison des Jeunes',
    'Poste',
    'MinistÃ¨re',
    'Budget 2021'
  ];

  options = {
    layers: [
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: 'Â© OpenStreetMap contributors'
      })
    ],
    zoom: 7,
    center: L.latLng(33.8869, 9.5375)
  };

  constructor(private mapService: MapDataService) {}

  onMapReady(map: L.Map) {
    this.map = map;
    this.loadStandardData('Toutes');
  }

  onCategoryChange(event: any) {
    const selectedCat = event.target.value;
    
    // Nettoyage du calque prÃ©cÃ©dent
    if (this.currentLayer && this.map) {
      this.map.removeLayer(this.currentLayer);
      this.currentLayer = null;
    }

    if (selectedCat === 'Budget 2021') {
      this.loadBudgetData();
    } else {
      this.loadStandardData(selectedCat);
    }
  }

  // --- LOGIQUE BUDGET 2021 (Somme PrÃ©vision + Popup Complet) ---
  loadBudgetData() {
    this.mapService.getBudget2021().subscribe({
      next: (data) => {
        const budgetCluster = L.markerClusterGroup({
          maxClusterRadius: 60,
          // CrÃ©ation de l'icÃ´ne du cluster avec la SOMME
          iconCreateFunction: (cluster) => {
            const markers = cluster.getAllChildMarkers();
            let totalPrevision = 0;

            // Addition des montants stockÃ©s dans les options des marqueurs
            markers.forEach((marker: any) => {
              if (marker.options.previsionAmount) {
                totalPrevision += marker.options.previsionAmount;
              }
            });

            // Formatage (Ex: 1 200 TND)
            const formattedSum = new Intl.NumberFormat('fr-TN', { 
              style: 'currency', currency: 'TND', maximumFractionDigits: 0 
            }).format(totalPrevision);

            return L.divIcon({
              html: `<div class="budget-cluster-icon">
                       <span>${formattedSum}</span>
                       <small>(${markers.length} mun.)</small>
                     </div>`,
              className: 'budget-cluster',
              iconSize: L.point(90, 90)
            });
          }
        });

        data.forEach(item => {
          const lat = parseFloat(item.lat);
          const lng = parseFloat(item.lng);

          // Nettoyage et parsing de 'depenses_prevision'
          const rawPrevision = item.depenses_prevision ? String(item.depenses_prevision) : '0';
          const valPrevision = parseFloat(rawPrevision.replace(/\s/g, '').replace(',', '.'));

          if (!isNaN(lat) && !isNaN(lng)) {
            const marker = L.marker([lat, lng], {
              icon: L.icon({
                iconUrl: 'assets/marker-icon.png',
                shadowUrl: 'assets/marker-shadow.png',
                iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34]
              })
            });

            // On stocke la valeur pour le calcul du cluster
            (marker.options as any)['previsionAmount'] = valPrevision;

            // Popup : Tous les champs
            marker.bindPopup(this.generateFullPopup(item));
            budgetCluster.addLayer(marker);
          }
        });

        this.currentLayer = budgetCluster;
        this.map.addLayer(this.currentLayer);
        
        if (data.length > 0) {
            const bounds = budgetCluster.getBounds();
            if (bounds.isValid()) this.map.fitBounds(bounds);
        }
      },
      error: (err) => console.error('Erreur Budget:', err)
    });
  }

  loadStandardData(category: string) {
    this.mapService.getLocations().subscribe({
      next: (locations) => {
        const filtered = category === 'Toutes' ? locations : locations.filter(l => l.categorie === category);
        const layerGroup = L.layerGroup();

        filtered.forEach(loc => {
          const marker = L.marker([loc.lat, loc.lng], {
            icon: L.icon({
               iconUrl: 'assets/marker-icon.png',
               shadowUrl: 'assets/marker-shadow.png',
               iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34]
            })
          });
          marker.bindPopup(`<b>${loc.nom}</b><br>${loc.categorie}`);
          layerGroup.addLayer(marker);
        });

        this.currentLayer = layerGroup;
        this.map.addLayer(this.currentLayer);
      }
    });
  }

  // GÃ©nÃ¨re un tableau HTML pour TOUTES les propriÃ©tÃ©s du JSON
  generateFullPopup(data: any): string {
    let rows = '';
    for (const key in data) {
      if (data.hasOwnProperty(key) && key !== 'lat' && key !== 'lng') {
         // Petite mise en forme pour le libellÃ©
         const label = key; 
         rows += `
          <tr>
            <td style="font-weight:bold; color:#555; padding:3px; border-bottom:1px solid #eee;">${label}</td>
            <td style="padding:3px; border-bottom:1px solid #eee;">${data[key]}</td>
          </tr>`;
      }
    }
    return `<div style="max-height:300px; overflow-y:auto; min-width:250px;">
              <h3 style="margin-top:0; color:#28a745; font-size:14px;">DÃ©tails</h3>
              <table style="width:100%; border-collapse:collapse; font-size:12px;"><tbody>${rows}</tbody></table>
            </div>`;
  }
}

------------------------------
ðŸ“„ Fichier : src/app/app.css
------------------------------
/* Layout Principal */
.map-container {
  position: relative;
  height: 100vh;
  width: 100%;
  display: flex;
  flex-direction: column;
}

#map {
  flex-grow: 1;
  width: 100%;
  height: 100%;
  z-index: 1;
}

/* ContrÃ´les */
.map-controls {
  position: absolute;
  top: 20px;
  right: 20px;
  z-index: 1000;
  background: white;
  padding: 10px 15px;
  border-radius: 8px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
  font-family: Arial, sans-serif;
}
.map-controls select { margin-left: 10px; padding: 5px; }

/* Cluster Vert (Budget) */
::ng-deep .budget-cluster-icon {
  background-color: rgba(40, 167, 69, 0.95);
  border: 3px solid white;
  border-radius: 50%;
  color: white;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  width: 90px;
  height: 90px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.4);
  text-align: center;
  font-family: Arial, sans-serif;
  cursor: pointer;
  transition: transform 0.2s;
}
::ng-deep .budget-cluster-icon:hover {
  background-color: #218838;
  transform: scale(1.1);
  z-index: 9999;
}
::ng-deep .budget-cluster-icon span { font-weight: bold; font-size: 12px; }
::ng-deep .budget-cluster-icon small { font-size: 10px; font-weight: normal; }

------------------------------
ðŸ“„ Fichier : src/app/app.component.ts
------------------------------
import { Component } from '@angular/core';
import { CommonModule } from '@angular/common'; 
import { HttpClientModule } from '@angular/common/http';
// On utilise LeafletModule. Si cela Ã©choue, vÃ©rifiez votre package.json.
import { LeafletModule } from '@bluehalo/ngx-leaflet'; 
// import { LeafletModule } from 'ngx-leaflet'; // Alternative si bluehalo n'est pas installÃ©

import * as L from 'leaflet';
import 'leaflet.markercluster'; 
import { MapDataService } from './services/map-data.service';

@Component({
  selector: 'app-root',
  standalone: true,
  imports: [CommonModule, LeafletModule, HttpClientModule],
  templateUrl: './app.component.html',
  styleUrls: ['./app.component.css'],
  providers: [MapDataService]
})
export class AppComponent {
  map!: L.Map;
  currentLayer: any = null; // Stocke le calque actif pour pouvoir le supprimer

  // Liste des catÃ©gories en dur pour garantir l'affichage
  categories: string[] = [
    'LycÃ©e',
    'Maison des Jeunes',
    'Poste',
    'MinistÃ¨re',
    'Budget 2021'
  ];

  // Options de base de la carte (Vue Tunisie)
  options = {
    layers: [
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: 'Â© OpenStreetMap contributors'
      })
    ],
    zoom: 7,
    center: L.latLng(33.8869, 9.5375)
  };

  constructor(private mapService: MapDataService) {}

  onMapReady(map: L.Map) {
    this.map = map;
    // Charge les donnÃ©es classiques au dÃ©marrage
    this.loadStandardData('Toutes');
  }

  // Changement de catÃ©gorie via le Select
  onCategoryChange(event: any) {
    const selectedCat = event.target.value;
    
    // 1. Nettoyer la carte
    if (this.currentLayer && this.map) {
      this.map.removeLayer(this.currentLayer);
      this.currentLayer = null;
    }

    // 2. Choisir la logique de chargement
    if (selectedCat === 'Budget 2021') {
      this.loadBudgetData();
    } else {
      this.loadStandardData(selectedCat);
    }
  }

  // --- LOGIQUE SPÃ‰CIALE BUDGET 2021 ---
  loadBudgetData() {
    this.mapService.getBudget2021().subscribe({
      next: (data) => {
        // CrÃ©ation du groupe de cluster
        const budgetCluster = L.markerClusterGroup({
          maxClusterRadius: 60,
          // Fonction personnalisÃ©e pour l'icÃ´ne du cluster
          iconCreateFunction: (cluster) => {
            const markers = cluster.getAllChildMarkers();
            let totalPrevision = 0;

            // On additionne la propriÃ©tÃ© 'previsionAmount' stockÃ©e dans chaque marker
            markers.forEach((marker: any) => {
              if (marker.options.previsionAmount) {
                totalPrevision += marker.options.previsionAmount;
              }
            });

            // Formatage MonÃ©taire (TND)
            const formattedSum = new Intl.NumberFormat('fr-TN', { 
              style: 'currency', 
              currency: 'TND', 
              maximumFractionDigits: 0 
            }).format(totalPrevision);

            return L.divIcon({
              html: `<div class="budget-cluster-icon">
                       <span>${formattedSum}</span>
                       <small>(${markers.length} mun.)</small>
                     </div>`,
              className: 'budget-cluster',
              iconSize: L.point(90, 90)
            });
          }
        });

        // CrÃ©ation des marqueurs individuels
        data.forEach(item => {
          const lat = parseFloat(item.lat);
          const lng = parseFloat(item.lng);

          // NETTOYAGE: 'depenses_prevision' ("84000" ou "84 000") -> Float
          const rawPrevision = item.depenses_prevision ? String(item.depenses_prevision) : '0';
          // EnlÃ¨ve les espaces, remplace virgule par point
          const valPrevision = parseFloat(rawPrevision.replace(/\s/g, '').replace(',', '.'));

          if (!isNaN(lat) && !isNaN(lng)) {
            const marker = L.marker([lat, lng], {
              icon: L.icon({
                iconUrl: 'assets/marker-icon.png',
                shadowUrl: 'assets/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34]
              })
            });

            // IMPORTANT : On attache la valeur 'prevision' au marker pour le cluster
            (marker.options as any)['previsionAmount'] = valPrevision;

            // Popup : Affiche TOUS les champs
            marker.bindPopup(this.generateFullPopup(item));

            budgetCluster.addLayer(marker);
          }
        });

        this.currentLayer = budgetCluster;
        this.map.addLayer(this.currentLayer);
        
        // Zoom automatique sur les donnÃ©es
        if (data.length > 0) {
            const bounds = budgetCluster.getBounds();
            if (bounds.isValid()) this.map.fitBounds(bounds);
        }
      },
      error: (err) => console.error('Erreur chargement budget:', err)
    });
  }

  // --- LOGIQUE STANDARD (LycÃ©es, Postes...) ---
  loadStandardData(category: string) {
    this.mapService.getLocations().subscribe({
      next: (locations) => {
        const filtered = category === 'Toutes' 
          ? null 
          : locations.filter(l => l.categorie === category);

        const layerGroup = L.layerGroup();

        if(filtered )filtered.forEach(loc => {
          const marker = L.marker([loc.lat, loc.lng], {
            icon: L.icon({
              iconUrl: 'assets/marker-icon.png',
              shadowUrl: 'assets/marker-shadow.png',
              iconSize: [25, 41],
              iconAnchor: [12, 41],
              popupAnchor: [1, -34]
            })
          });
          marker.bindPopup(`<b>${loc.nom}</b><br>${loc.categorie}`);
          layerGroup.addLayer(marker);
        });

        this.currentLayer = layerGroup;
        this.map.addLayer(this.currentLayer);
      }
    });
  }

  // GÃ©nÃ¨re un tableau HTML avec TOUTES les clÃ©s du JSON
  generateFullPopup(data: any): string {
    let rows = '';
    // On parcourt toutes les clÃ©s de l'objet
    for (const key in data) {
      if (data.hasOwnProperty(key)) {
        // On exclut lat/lng car c'est redondant, mais on garde tout le reste
        if (key !== 'lat' && key !== 'lng') {
           rows += `
            <tr>
              <td style="font-weight:bold; color:#555; padding:4px; border-bottom:1px solid #eee;">${key}</td>
              <td style="padding:4px; border-bottom:1px solid #eee;">${data[key]}</td>
            </tr>`;
        }
      }
    }

    return `
      <div style="max-height: 300px; overflow-y: auto; font-family: sans-serif; min-width: 250px;">
        <h3 style="margin-top:0; color:#28a745; border-bottom: 2px solid #28a745;">DÃ©tails Budget</h3>
        <table style="width:100%; border-collapse: collapse; font-size: 12px;">
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;
  }
}

------------------------------
ðŸ“„ Fichier : src/app/app.config.ts
------------------------------
import { ApplicationConfig, provideBrowserGlobalErrorListeners, provideZoneChangeDetection } from '@angular/core';
import { provideHttpClient } from '@angular/common/http';

export const appConfig: ApplicationConfig = {
  providers: [
    provideBrowserGlobalErrorListeners(),
    provideZoneChangeDetection({ eventCoalescing: true }),
    provideHttpClient()
  ]
};

------------------------------
ðŸ“„ Fichier : src/app/app.component.css
------------------------------
/* Layout Principal */
.map-container {
  position: relative;
  height: 100vh;
  width: 100%;
  display: flex;
  flex-direction: column;
}

#map {
  flex-grow: 1;
  width: 100%;
  height: 100%;
  z-index: 1;
}

/* ContrÃ´les Flottants */
.map-controls {
  position: absolute;
  top: 20px;
  right: 20px;
  z-index: 1000; /* Au-dessus de la carte */
  background: white;
  padding: 15px;
  border-radius: 8px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
  font-family: Arial, sans-serif;
}

.map-controls select {
  margin-left: 10px;
  padding: 5px;
  font-size: 14px;
}

/* Styles du Cluster Budget (Bulles Vertes) */
::ng-deep .budget-cluster-icon {
  background-color: rgba(40, 167, 69, 0.95); /* Vert Bootstrap */
  border: 3px solid white;
  border-radius: 50%;
  color: white;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  width: 90px;
  height: 90px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.4);
  text-align: center;
  font-family: 'Segoe UI', Arial, sans-serif;
  transition: transform 0.2s;
  cursor: pointer;
}

::ng-deep .budget-cluster-icon:hover {
  background-color: #218838;
  transform: scale(1.1);
  z-index: 9999;
}

::ng-deep .budget-cluster-icon span {
  font-weight: bold;
  font-size: 12px;
  line-height: 1.2;
}

::ng-deep .budget-cluster-icon small {
  font-size: 10px;
  opacity: 0.9;
  margin-top: 2px;
  font-weight: normal;
}

------------------------------
ðŸ“„ Fichier : src/app/app.html
------------------------------
{{categories|json}}
<div class="map-container">
  
  <div class="map-controls">
    <label for="catSelect"><strong>Choisissez une catÃ©gorie :</strong></label>
    <select id="catSelect" (change)="onCategoryChange($any($event))">
      <option *ngFor="let cat of categories" [value]="cat">
        {{ cat }}
      </option>
    </select>
  </div>

  <div
    id="map"
    leaflet
    [leafletOptions]="options"
    (leafletMapReady)="onMapReady($any($event))">
  </div>

</div>

------------------------------
ðŸ“„ Fichier : src/app/services/map-data.service.ts
------------------------------
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Observable } from 'rxjs';

@Injectable({
  providedIn: 'root'
})
export class MapDataService {
  constructor(private http: HttpClient) { }

  getLocations(): Observable<any[]> {
    // Les Ã©tablissements classiques (LycÃ©es, etc.)
    return this.http.get<any[]>('assets/all_locations.json');
  }

  getBudget2021(): Observable<any[]> {
    // Le fichier spÃ©cifique Budget
    return this.http.get<any[]>('assets/budget2021.json');
  }
}

------------------------------
ðŸ“„ Fichier : src/app/services/map-data.ts
------------------------------
import { Injectable } from '@angular/core';

@Injectable({
  providedIn: 'root',
})
export class MapData {
  
}

